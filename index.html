<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <!-- iOS 安裝到主畫面支援 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="OLED Clock" />
  <title>OLED Safe Clock</title>
  <style>
    :root {
      --bg: #000; /* 全黑省電 */
      --fg: #e6e6e6; /* 柔和白 */
      --accent: #7dd3fc; /* 淡藍點綴 */
      --nudge-x: 0px;/* 防烙印位移 - 只左右 */
      --safe-padding: env(safe-area-inset-left, 0px);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden; /* 防止位移時出現捲動 */
    }

    /* 主要舞台 */
    #stage {
      position: fixed; inset: 0; display: grid; place-items: center;
      padding: 12px; padding-left: calc(12px + var(--safe-padding));
    }

    /* HUD（右上角） */
    .hud { position: fixed; top: 8px; right: 8px; display: flex; gap: 8px; align-items: center; z-index: 20; }
    .hud button {
      font-size: 18px; line-height: 1; padding: 10px 12px; border-radius: 14px; border: 1px solid #333; background: #111; color: var(--fg);
      box-shadow: 0 4px 16px rgba(0,0,0,.35); cursor: pointer; opacity: .9; backdrop-filter: blur(4px);
    }
    .hud button:active { transform: scale(.98); }
    #visitors { padding: 8px 12px; border-radius: 12px; background: #0b0b0b; border: 1px solid #232323; font-size: 14px; }

    /* 時鐘塊 */
    .clock { text-align: center; transform: translateX(var(--nudge-x)); will-change: transform; }
    .time {
      font-weight: 700; letter-spacing: 0.04em; line-height: .95;
      font-size: clamp(54px, 16vw, 160px);
      text-shadow: 0 0 8px rgba(125,211,252,.15);
    }
    .date { opacity: .9; font-size: clamp(16px, 3.6vw, 28px); margin-top: 6px; color: #c9c9c9; }

    /* 提示 */
    .hint {
      position: fixed; left: 12px; bottom: 12px; z-index: 10;
      font-size: 14px; opacity: .85; color: #cfcfcf; background: #101010; border: 1px solid #272727; padding: 8px 12px; border-radius: 12px;
    }

    /* 設定面板 */
    #panel {
      position: fixed; right: 10px; top: 54px; width: min(86vw, 360px); z-index: 30;
      background: #0d0d0d; border: 1px solid #2a2a2a; border-radius: 16px; padding: 14px 14px 10px;
      box-shadow: 0 12px 34px rgba(0,0,0,.55);
    }
    #panel h3 { margin: 0 0 8px; font-size: 16px; }
    #panel .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 4px; }
    #panel input[type="number"] { width: 90px; }
    #panel hr { border: none; border-top: 1px solid #232323; margin: 8px 0; }
    #panel label { font-size: 14px; color: #ddd; }

    /* 小動物（emoji 走位） */
    #animals { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0; }
    .ani { position: absolute; font-size: clamp(24px, 6vw, 42px); filter: drop-shadow(0 2px 6px rgba(0,0,0,.5)); opacity: .95; }
    @keyframes swim {
      from { transform: translateX(120vw) }
      to { transform: translateX(-140vw) }
    }

    /* 自動隱藏 HUD */
    .hud.hidden { opacity: 0; pointer-events: none; transition: opacity .4s ease; }

    @media (display-mode: standalone) {
      body { padding-left: var(--safe-padding); }
    }

    @media (prefers-reduced-motion: reduce) {
      .time { text-shadow: none; }
      .ani { display: none !important; }
    }
  </style>
</head>
<body>
  <header class="hud" id="hud">
    <button id="fsBtn" title="切換全螢幕">⤢ 全螢幕</button>
    <button id="gearBtn" title="設定">⚙️ 設定</button>
    <div id="visitors" title="瀏覽次數">👀 <span id="viewCount">—</span></div>
  </header>

  <main id="stage" aria-live="polite">
    <div class="clock" data-burnin>
      <div class="time" id="time">00:00:00</div>
      <div class="date" id="date">—</div>
    </div>

    <div id="animals" aria-hidden="true"></div>

    <div id="tapHint" class="hint">輕點畫面可嘗試全螢幕（建議加入主畫面）</div>
  </main>

  <aside id="panel" hidden>
    <h3>⚙️ 設定</h3>
    <div class="row"><label>24 小時制</label><input type="checkbox" id="opt24h"></div>
    <div class="row"><label>顯示秒數</label><input type="checkbox" id="optSec"></div>
    <div class="row"><label>啟動時自動全螢幕（需互動）</label><input type="checkbox" id="optAutoFS"></div>
    <hr/>
    <div class="row"><label>防烙印位移（像素）</label><input type="number" id="optNudge" min="0" max="20" step="1" value="10"></div>
    <div class="row"><label>位移週期（分鐘）</label><input type="number" id="optNudgeMin" min="1" max="30" step="1" value="2"></div>
    <div class="row"><label>小動物特效</label><input type="checkbox" id="optAnimals" checked></div>
  </aside>

  <script>
    // ========= 工具 =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // ========= 儲存設定 =========
    const store = {
      get() {
        try {
          return JSON.parse(localStorage.getItem('oledClockCfg')||'{}');
        } catch { return {}; }
      },
      set(cfg) { localStorage.setItem('oledClockCfg', JSON.stringify(cfg)); }
    };
    const cfg = Object.assign({
      h24: true,
      showSec: true,
      autoFS: false,
      nudgePx: 10,
      nudgeMin: 2,
      animals: true,
    }, store.get());

    // ========= 時鐘 =========
    const timeEl = $('#time');
    const dateEl = $('#date');

    function fmt2(n){ return n<10? '0'+n : ''+n; }
    function tick(){
      const now = new Date();
      let h = now.getHours();
      const m = now.getMinutes();
      const s = now.getSeconds();
      if (!cfg.h24) { h = ((h+11)%12)+1; }
      timeEl.textContent = cfg.showSec
        ? `${fmt2(h)}:${fmt2(m)}:${fmt2(s)}`
        : `${fmt2(h)}:${fmt2(m)}`;
      const weekdays = ['日','一','二','三','四','五','六'];
      dateEl.textContent = `${now.getFullYear()}-${fmt2(now.getMonth()+1)}-${fmt2(now.getDate())}（${weekdays[now.getDay()]}）`;
    }
    setInterval(tick, 250); tick();

    // ========= 防烙印位移（只左右） =========
    function randomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function nudge(){
      const amp = Math.max(0, Math.min(20, Number(cfg.nudgePx)||0));
      const dx = amp===0 ? 0 : randomInt(-amp, amp);
      document.documentElement.style.setProperty('--nudge-x', dx+'px');
    }
    // 每 cfg.nudgeMin 分鐘位移一次
    let nudgeTimer;
    function startNudger(){
      clearInterval(nudgeTimer);
      nudge();
      const ms = Math.max(1, Number(cfg.nudgeMin)||2) * 60 * 1000;
      nudgeTimer = setInterval(nudge, ms);
    }
    startNudger();

    // ========= 小動物（emoji 橫向游動） =========
    const animalsWrap = $('#animals');
    const animalList = ['🐟','🐱','🐦','🦊','🐧','🐢'];
    function spawnAnimal(){
      if (!cfg.animals) return;
      const el = document.createElement('div');
      el.className = 'ani';
      el.textContent = animalList[Math.floor(Math.random()*animalList.length)];
      const y = Math.random()*80 + 10; // 10% ~ 90% 視窗高度
      const dur = Math.random()*20 + 18; // 18 ~ 38 秒
      el.style.top = y+'vh';
      el.style.right = '-10vw';
      el.style.animation = `swim ${dur}s linear forwards`;
      animalsWrap.appendChild(el);
      setTimeout(()=> el.remove(), (dur+0.5)*1000);
    }
    // 每 7~14 秒隨機來一隻
    let animalTimer;
    function startAnimals(){
      if (animalTimer) clearInterval(animalTimer);
      if (!cfg.animals) return;
      animalTimer = setInterval(()=>{ if (cfg.animals) spawnAnimal(); }, (7000 + Math.random()*7000));
    }
    startAnimals();

    // ========= 瀏覽次數 =========
    (function views(){
      const key = 'pageViews';
      const v = Number(localStorage.getItem(key)||0) + 1;
      localStorage.setItem(key, v);
      $('#viewCount').textContent = v.toLocaleString();
      // 若想要全站累計（例如 GitHub Pages），可改用 Count API：
      // fetch('https://api.countapi.xyz/hit/<自訂命名空間>/<自訂key>')
      //   .then(r=>r.json()).then(d=> $('#viewCount').textContent = (d.value||v).toLocaleString())
      //   .catch(()=>{});
    })();

    // ========= 全螢幕與橫向鎖定 =========
    async function enterFullscreen(){
      try {
        if (!document.fullscreenElement) {
          await document.body.requestFullscreen();
        }
        if (screen.orientation && screen.orientation.lock) {
          try { await screen.orientation.lock('landscape'); } catch {}
        }
        $('#tapHint').style.display = 'none';
        fsBtn.textContent = '⤢ 退出全螢幕';
      } catch (e) {
        console.log('Fullscreen failed:', e);
      }
    }
    async function exitFullscreen(){
      try { if (document.fullscreenElement) await document.exitFullscreen(); } catch {}
      fsBtn.textContent = '⤢ 全螢幕';
    }

    const fsBtn = $('#fsBtn');
    fsBtn.addEventListener('click', ()=> {
      if (document.fullscreenElement) exitFullscreen(); else enterFullscreen();
    });

    // 首次互動若有開啟自動全螢幕
    let firstTapDone = false;
    async function firstTapHandler(){
      if (!firstTapDone) {
        firstTapDone = true;
        if (cfg.autoFS) await enterFullscreen();
      }
    }
    document.addEventListener('pointerdown', firstTapHandler, { once: true });

    // ========= 自動隱藏 HUD =========
    const hud = $('#hud');
    let hideTimer;
    function scheduleHideHUD(){
      clearTimeout(hideTimer);
      hud.classList.remove('hidden');
      hideTimer = setTimeout(()=> hud.classList.add('hidden'), 5000);
    }
    ['pointermove','pointerdown','keydown'].forEach(ev => document.addEventListener(ev, scheduleHideHUD));
    scheduleHideHUD();

    // ========= 設定面板 =========
    const panel = $('#panel');
    const gearBtn = $('#gearBtn');
    gearBtn.addEventListener('click', ()=> panel.hidden = !panel.hidden);

    const opt24h = $('#opt24h');
    const optSec = $('#optSec');
    const optAutoFS = $('#optAutoFS');
    const optNudge = $('#optNudge');
    const optNudgeMin = $('#optNudgeMin');
    const optAnimals = $('#optAnimals');

    // 初始化面板狀態
    opt24h.checked = cfg.h24;
    optSec.checked = cfg.showSec;
    optAutoFS.checked = cfg.autoFS;
    optNudge.value = cfg.nudgePx;
    optNudgeMin.value = cfg.nudgeMin;
    optAnimals.checked = cfg.animals;

    function save(){
      cfg.h24 = !!opt24h.checked;
      cfg.showSec = !!optSec.checked;
      cfg.autoFS = !!optAutoFS.checked;
      cfg.nudgePx = Math.max(0, Math.min(20, Number(optNudge.value)||0));
      cfg.nudgeMin = Math.max(1, Math.min(30, Number(optNudgeMin.value)||2));
      cfg.animals = !!optAnimals.checked;
      store.set(cfg);
      startNudger();
      startAnimals();
      tick();
    }
    panel.addEventListener('change', save);

    // ========= 安裝提示（PWA Partial） =========
    // 提供簡單的安裝到主畫面提示（Android 可用 Chrome 的「加入主畫面」功能）
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; // 某些平台可能不支援
      $('#tapHint').textContent = '可從瀏覽器選單「加入主畫面」獲得全螢幕體驗';
    });

    // ========= 裝置方向提示 =========
    function orientationHint(){
      if (window.matchMedia('(orientation: portrait)').matches) {
        $('#tapHint').textContent = '建議橫向使用，輕點可嘗試全螢幕';
      } else {
        $('#tapHint').textContent = '輕點畫面可嘗試全螢幕（建議加入主畫面）';
      }
    }
    window.addEventListener('orientationchange', orientationHint);
    orientationHint();
  </script>
</body>
</html>
