<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <!-- iOS å®‰è£åˆ°ä¸»ç•«é¢æ”¯æ´ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="OLED Clock" />
  <title>OLED Safe Clock</title>
  <style>
    :root {
      --bg: #000; /* å…¨é»‘çœé›» */
      --fg: #e6e6e6; /* æŸ”å’Œç™½ */
      --accent: #7dd3fc; /* æ·¡è—é»ç¶´ */
      --nudge-x: 0px;/* é˜²çƒ™å°ä½ç§» - åªå·¦å³ */
      --safe-padding: env(safe-area-inset-left, 0px);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden; /* é˜²æ­¢ä½ç§»æ™‚å‡ºç¾æ²å‹• */
    }

    /* ä¸»è¦èˆå° */
    #stage {
      position: fixed; inset: 0; display: grid; place-items: center;
      padding: 12px; padding-left: calc(12px + var(--safe-padding));
    }

    /* HUDï¼ˆå³ä¸Šè§’ï¼‰ */
    .hud { position: fixed; top: 8px; right: 8px; display: flex; gap: 8px; align-items: center; z-index: 20; }
    .hud button {
      font-size: 18px; line-height: 1; padding: 10px 12px; border-radius: 14px; border: 1px solid #333; background: #111; color: var(--fg);
      box-shadow: 0 4px 16px rgba(0,0,0,.35); cursor: pointer; opacity: .9; backdrop-filter: blur(4px);
    }
    .hud button:active { transform: scale(.98); }
    #visitors { padding: 8px 12px; border-radius: 12px; background: #0b0b0b; border: 1px solid #232323; font-size: 14px; }

    /* æ™‚é˜å¡Š */
    .clock { text-align: center; transform: translateX(var(--nudge-x)); will-change: transform; }
    .time {
      font-weight: 700; letter-spacing: 0.04em; line-height: .95;
      font-size: clamp(54px, 16vw, 160px);
      text-shadow: 0 0 8px rgba(125,211,252,.15);
    }
    .date { opacity: .9; font-size: clamp(16px, 3.6vw, 28px); margin-top: 6px; color: #c9c9c9; }

    /* æç¤º */
    .hint {
      position: fixed; left: 12px; bottom: 12px; z-index: 10;
      font-size: 14px; opacity: .85; color: #cfcfcf; background: #101010; border: 1px solid #272727; padding: 8px 12px; border-radius: 12px;
    }

    /* è¨­å®šé¢æ¿ */
    #panel {
      position: fixed; right: 10px; top: 54px; width: min(86vw, 360px); z-index: 30;
      background: #0d0d0d; border: 1px solid #2a2a2a; border-radius: 16px; padding: 14px 14px 10px;
      box-shadow: 0 12px 34px rgba(0,0,0,.55);
    }
    #panel h3 { margin: 0 0 8px; font-size: 16px; }
    #panel .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 4px; }
    #panel input[type="number"] { width: 90px; }
    #panel hr { border: none; border-top: 1px solid #232323; margin: 8px 0; }
    #panel label { font-size: 14px; color: #ddd; }

    /* å°å‹•ç‰©ï¼ˆemoji èµ°ä½ï¼‰ */
    #animals { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0; }
    .ani { position: absolute; font-size: clamp(24px, 6vw, 42px); filter: drop-shadow(0 2px 6px rgba(0,0,0,.5)); opacity: .95; }
    @keyframes swim {
      from { transform: translateX(120vw) }
      to { transform: translateX(-140vw) }
    }

    /* è‡ªå‹•éš±è— HUD */
    .hud.hidden { opacity: 0; pointer-events: none; transition: opacity .4s ease; }

    @media (display-mode: standalone) {
      body { padding-left: var(--safe-padding); }
    }

    @media (prefers-reduced-motion: reduce) {
      .time { text-shadow: none; }
      .ani { display: none !important; }
    }
  </style>
</head>
<body>
  <header class="hud" id="hud">
    <button id="fsBtn" title="åˆ‡æ›å…¨è¢å¹•">â¤¢ å…¨è¢å¹•</button>
    <button id="gearBtn" title="è¨­å®š">âš™ï¸ è¨­å®š</button>
    <div id="visitors" title="ç€è¦½æ¬¡æ•¸">ğŸ‘€ <span id="viewCount">â€”</span></div>
  </header>

  <main id="stage" aria-live="polite">
    <div class="clock" data-burnin>
      <div class="time" id="time">00:00:00</div>
      <div class="date" id="date">â€”</div>
    </div>

    <div id="animals" aria-hidden="true"></div>

    <div id="tapHint" class="hint">è¼•é»ç•«é¢å¯å˜—è©¦å…¨è¢å¹•ï¼ˆå»ºè­°åŠ å…¥ä¸»ç•«é¢ï¼‰</div>
  </main>

  <aside id="panel" hidden>
    <h3>âš™ï¸ è¨­å®š</h3>
    <div class="row"><label>24 å°æ™‚åˆ¶</label><input type="checkbox" id="opt24h"></div>
    <div class="row"><label>é¡¯ç¤ºç§’æ•¸</label><input type="checkbox" id="optSec"></div>
    <div class="row"><label>å•Ÿå‹•æ™‚è‡ªå‹•å…¨è¢å¹•ï¼ˆéœ€äº’å‹•ï¼‰</label><input type="checkbox" id="optAutoFS"></div>
    <hr/>
    <div class="row"><label>é˜²çƒ™å°ä½ç§»ï¼ˆåƒç´ ï¼‰</label><input type="number" id="optNudge" min="0" max="20" step="1" value="10"></div>
    <div class="row"><label>ä½ç§»é€±æœŸï¼ˆåˆ†é˜ï¼‰</label><input type="number" id="optNudgeMin" min="1" max="30" step="1" value="2"></div>
    <div class="row"><label>å°å‹•ç‰©ç‰¹æ•ˆ</label><input type="checkbox" id="optAnimals" checked></div>
  </aside>

  <script>
    // ========= å·¥å…· =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // ========= å„²å­˜è¨­å®š =========
    const store = {
      get() {
        try {
          return JSON.parse(localStorage.getItem('oledClockCfg')||'{}');
        } catch { return {}; }
      },
      set(cfg) { localStorage.setItem('oledClockCfg', JSON.stringify(cfg)); }
    };
    const cfg = Object.assign({
      h24: true,
      showSec: true,
      autoFS: false,
      nudgePx: 10,
      nudgeMin: 2,
      animals: true,
    }, store.get());

    // ========= æ™‚é˜ =========
    const timeEl = $('#time');
    const dateEl = $('#date');

    function fmt2(n){ return n<10? '0'+n : ''+n; }
    function tick(){
      const now = new Date();
      let h = now.getHours();
      const m = now.getMinutes();
      const s = now.getSeconds();
      if (!cfg.h24) { h = ((h+11)%12)+1; }
      timeEl.textContent = cfg.showSec
        ? `${fmt2(h)}:${fmt2(m)}:${fmt2(s)}`
        : `${fmt2(h)}:${fmt2(m)}`;
      const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      dateEl.textContent = `${now.getFullYear()}-${fmt2(now.getMonth()+1)}-${fmt2(now.getDate())}ï¼ˆ${weekdays[now.getDay()]}ï¼‰`;
    }
    setInterval(tick, 250); tick();

    // ========= é˜²çƒ™å°ä½ç§»ï¼ˆåªå·¦å³ï¼‰ =========
    function randomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function nudge(){
      const amp = Math.max(0, Math.min(20, Number(cfg.nudgePx)||0));
      const dx = amp===0 ? 0 : randomInt(-amp, amp);
      document.documentElement.style.setProperty('--nudge-x', dx+'px');
    }
    // æ¯ cfg.nudgeMin åˆ†é˜ä½ç§»ä¸€æ¬¡
    let nudgeTimer;
    function startNudger(){
      clearInterval(nudgeTimer);
      nudge();
      const ms = Math.max(1, Number(cfg.nudgeMin)||2) * 60 * 1000;
      nudgeTimer = setInterval(nudge, ms);
    }
    startNudger();

    // ========= å°å‹•ç‰©ï¼ˆemoji æ©«å‘æ¸¸å‹•ï¼‰ =========
    const animalsWrap = $('#animals');
    const animalList = ['ğŸŸ','ğŸ±','ğŸ¦','ğŸ¦Š','ğŸ§','ğŸ¢'];
    function spawnAnimal(){
      if (!cfg.animals) return;
      const el = document.createElement('div');
      el.className = 'ani';
      el.textContent = animalList[Math.floor(Math.random()*animalList.length)];
      const y = Math.random()*80 + 10; // 10% ~ 90% è¦–çª—é«˜åº¦
      const dur = Math.random()*20 + 18; // 18 ~ 38 ç§’
      el.style.top = y+'vh';
      el.style.right = '-10vw';
      el.style.animation = `swim ${dur}s linear forwards`;
      animalsWrap.appendChild(el);
      setTimeout(()=> el.remove(), (dur+0.5)*1000);
    }
    // æ¯ 7~14 ç§’éš¨æ©Ÿä¾†ä¸€éš»
    let animalTimer;
    function startAnimals(){
      if (animalTimer) clearInterval(animalTimer);
      if (!cfg.animals) return;
      animalTimer = setInterval(()=>{ if (cfg.animals) spawnAnimal(); }, (7000 + Math.random()*7000));
    }
    startAnimals();

    // ========= ç€è¦½æ¬¡æ•¸ =========
    (function views(){
      const key = 'pageViews';
      const v = Number(localStorage.getItem(key)||0) + 1;
      localStorage.setItem(key, v);
      $('#viewCount').textContent = v.toLocaleString();
      // è‹¥æƒ³è¦å…¨ç«™ç´¯è¨ˆï¼ˆä¾‹å¦‚ GitHub Pagesï¼‰ï¼Œå¯æ”¹ç”¨ Count APIï¼š
      // fetch('https://api.countapi.xyz/hit/<è‡ªè¨‚å‘½åç©ºé–“>/<è‡ªè¨‚key>')
      //   .then(r=>r.json()).then(d=> $('#viewCount').textContent = (d.value||v).toLocaleString())
      //   .catch(()=>{});
    })();

    // ========= å…¨è¢å¹•èˆ‡æ©«å‘é–å®š =========
    async function enterFullscreen(){
      try {
        if (!document.fullscreenElement) {
          await document.body.requestFullscreen();
        }
        if (screen.orientation && screen.orientation.lock) {
          try { await screen.orientation.lock('landscape'); } catch {}
        }
        $('#tapHint').style.display = 'none';
        fsBtn.textContent = 'â¤¢ é€€å‡ºå…¨è¢å¹•';
      } catch (e) {
        console.log('Fullscreen failed:', e);
      }
    }
    async function exitFullscreen(){
      try { if (document.fullscreenElement) await document.exitFullscreen(); } catch {}
      fsBtn.textContent = 'â¤¢ å…¨è¢å¹•';
    }

    const fsBtn = $('#fsBtn');
    fsBtn.addEventListener('click', ()=> {
      if (document.fullscreenElement) exitFullscreen(); else enterFullscreen();
    });

    // é¦–æ¬¡äº’å‹•è‹¥æœ‰é–‹å•Ÿè‡ªå‹•å…¨è¢å¹•
    let firstTapDone = false;
    async function firstTapHandler(){
      if (!firstTapDone) {
        firstTapDone = true;
        if (cfg.autoFS) await enterFullscreen();
      }
    }
    document.addEventListener('pointerdown', firstTapHandler, { once: true });

    // ========= è‡ªå‹•éš±è— HUD =========
    const hud = $('#hud');
    let hideTimer;
    function scheduleHideHUD(){
      clearTimeout(hideTimer);
      hud.classList.remove('hidden');
      hideTimer = setTimeout(()=> hud.classList.add('hidden'), 5000);
    }
    ['pointermove','pointerdown','keydown'].forEach(ev => document.addEventListener(ev, scheduleHideHUD));
    scheduleHideHUD();

    // ========= è¨­å®šé¢æ¿ =========
    const panel = $('#panel');
    const gearBtn = $('#gearBtn');
    gearBtn.addEventListener('click', ()=> panel.hidden = !panel.hidden);

    const opt24h = $('#opt24h');
    const optSec = $('#optSec');
    const optAutoFS = $('#optAutoFS');
    const optNudge = $('#optNudge');
    const optNudgeMin = $('#optNudgeMin');
    const optAnimals = $('#optAnimals');

    // åˆå§‹åŒ–é¢æ¿ç‹€æ…‹
    opt24h.checked = cfg.h24;
    optSec.checked = cfg.showSec;
    optAutoFS.checked = cfg.autoFS;
    optNudge.value = cfg.nudgePx;
    optNudgeMin.value = cfg.nudgeMin;
    optAnimals.checked = cfg.animals;

    function save(){
      cfg.h24 = !!opt24h.checked;
      cfg.showSec = !!optSec.checked;
      cfg.autoFS = !!optAutoFS.checked;
      cfg.nudgePx = Math.max(0, Math.min(20, Number(optNudge.value)||0));
      cfg.nudgeMin = Math.max(1, Math.min(30, Number(optNudgeMin.value)||2));
      cfg.animals = !!optAnimals.checked;
      store.set(cfg);
      startNudger();
      startAnimals();
      tick();
    }
    panel.addEventListener('change', save);

    // ========= å®‰è£æç¤ºï¼ˆPWA Partialï¼‰ =========
    // æä¾›ç°¡å–®çš„å®‰è£åˆ°ä¸»ç•«é¢æç¤ºï¼ˆAndroid å¯ç”¨ Chrome çš„ã€ŒåŠ å…¥ä¸»ç•«é¢ã€åŠŸèƒ½ï¼‰
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt = e; // æŸäº›å¹³å°å¯èƒ½ä¸æ”¯æ´
      $('#tapHint').textContent = 'å¯å¾ç€è¦½å™¨é¸å–®ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ç²å¾—å…¨è¢å¹•é«”é©—';
    });

    // ========= è£ç½®æ–¹å‘æç¤º =========
    function orientationHint(){
      if (window.matchMedia('(orientation: portrait)').matches) {
        $('#tapHint').textContent = 'å»ºè­°æ©«å‘ä½¿ç”¨ï¼Œè¼•é»å¯å˜—è©¦å…¨è¢å¹•';
      } else {
        $('#tapHint').textContent = 'è¼•é»ç•«é¢å¯å˜—è©¦å…¨è¢å¹•ï¼ˆå»ºè­°åŠ å…¥ä¸»ç•«é¢ï¼‰';
      }
    }
    window.addEventListener('orientationchange', orientationHint);
    orientationHint();
  </script>
</body>
</html>
